name: Update CV with Citation Badges

on:
  push:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-cv:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download CV from Google Drive
        run: |
          FILE_ID="1bB2WnhJIigiq-S9CmZNKPpmEYytFz98U"
          curl -L "https://drive.google.com/uc?export=download&id=${FILE_ID}" -o cv_source.docx
      
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.0'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev
      
      - name: Install R packages
        run: |
          install.packages(c("httr", "jsonlite"), repos = "https://cloud.r-project.org")
        shell: Rscript {0}
      
      - name: Process CV with citation badges
        env:
          SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
        run: |
          Rscript process_cv.R cv_source.docx ${{ github.workspace }}/cv_with_badges.docx
          echo "Checking output:"
          ls -la ${{ github.workspace }}/cv_with_badges.docx || echo "Not in workspace"
          ls -la cv_with_badges.docx || echo "Not in current dir"
          ls -la /tmp/*.docx 2>/dev/null || echo "Not in tmp"
      
      - name: Install LibreOffice
        run: |
          sudo apt-get install -y libreoffice-writer
      
      - name: Convert to PDF
        run: |
          echo "üìÑ Converting to PDF..."
          echo "Files in directory:"
          ls -la
          
          # Convert using full path
          libreoffice --headless --convert-to pdf --outdir . cv_with_badges.docx
          
          echo "After conversion:"
          ls -la *.pdf || echo "No PDF found"
          
          # Create output directory and move files
          mkdir -p _site/cv
          
          if [ -f "cv_with_badges.pdf" ]; then
            mv cv_with_badges.pdf _site/cv/cv.pdf
            mv cv_with_badges.docx _site/cv/cv.docx
            echo "‚úÖ PDF created successfully"
          else
            echo "‚ùå PDF conversion failed, copying docx only"
            cp cv_with_badges.docx _site/cv/cv.docx
            exit 1
          fi
      
      - name: Commit updated CV
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add _site/cv/
          git diff --staged --quiet || git commit -m "Update CV with latest citations [skip ci]"
          git push